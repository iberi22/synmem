# .github/workflows/update-protocol.yml
# üîÑ Auto-update Git-Core Protocol files when new version is available
#
# This workflow checks weekly (or manually) if there's a new version
# of the Git-Core Protocol and creates a PR with the updates.

name: üîÑ Update Git-Core Protocol

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version matches'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Check current protocol version
        id: current
        run: |
          if [ -f ".git-core-protocol-version" ]; then
            CURRENT_VERSION=$(cat .git-core-protocol-version)
          else
            CURRENT_VERSION="0.0.0"
          fi
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "üìå Current version: $CURRENT_VERSION"

      - name: üåê Fetch latest protocol version
        id: latest
        run: |
          LATEST_VERSION=$(curl -sL https://raw.githubusercontent.com/iberi22/ai-git-core-template/main/.git-core-protocol-version 2>/dev/null || echo "0.0.0")
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "üÜï Latest version: $LATEST_VERSION"

      - name: üîÑ Check if update needed
        id: check
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.latest.outputs.version }}"
          FORCE="${{ inputs.force_update }}"

          if [ "$FORCE" = "true" ] || [ "$CURRENT" != "$LATEST" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Update needed: $CURRENT ‚Üí $LATEST"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Already up to date"
          fi

      - name: üì¶ Download protocol files
        if: steps.check.outputs.needs_update == 'true'
        run: |
          echo "üì• Downloading latest protocol files..."

          # Base URL
          BASE_URL="https://raw.githubusercontent.com/iberi22/ai-git-core-template/main"

          # Create directories
          mkdir -p .ai .github

          # Download protocol files (preserving local customizations where possible)
          curl -sL "$BASE_URL/AGENTS.md" -o AGENTS.md.new
          curl -sL "$BASE_URL/.cursorrules" -o .cursorrules.new
          curl -sL "$BASE_URL/.windsurfrules" -o .windsurfrules.new
          curl -sL "$BASE_URL/.github/copilot-instructions.md" -o .github/copilot-instructions.md.new
          curl -sL "$BASE_URL/.git-core-protocol-version" -o .git-core-protocol-version.new

          # Move files (only protocol files, not project-specific ones)
          mv AGENTS.md.new AGENTS.md
          mv .cursorrules.new .cursorrules
          mv .windsurfrules.new .windsurfrules
          mv .github/copilot-instructions.md.new .github/copilot-instructions.md
          mv .git-core-protocol-version.new .git-core-protocol-version

          echo "‚úÖ Protocol files updated"

      - name: üîÄ Create Pull Request
        if: steps.check.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: üîÑ Update Git-Core Protocol to ${{ steps.latest.outputs.version }}"
          title: "üîÑ Update Git-Core Protocol to ${{ steps.latest.outputs.version }}"
          body: |
            ## üîÑ Git-Core Protocol Update

            This PR updates the Git-Core Protocol configuration files.

            **Version:** `${{ steps.current.outputs.version }}` ‚Üí `${{ steps.latest.outputs.version }}`

            ### üì¶ Updated Files
            - `AGENTS.md` - Agent configuration
            - `.cursorrules` - Cursor AI rules
            - `.windsurfrules` - Windsurf AI rules
            - `.github/copilot-instructions.md` - GitHub Copilot instructions

            ### ‚ö†Ô∏è Review Notes
            - Check if any local customizations need to be preserved
            - Review the [changelog](https://github.com/iberi22/ai-git-core-template/releases) for breaking changes

            ---
            *Auto-generated by Git-Core Protocol Update Workflow*
          branch: chore/update-git-core-protocol
          delete-branch: true
          labels: |
            dependencies
            automated
