name: ðŸ” Structure Validator

on:
  push:
    branches: ['*']
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  CARGO_TERM_COLOR: always

jobs:
  validate-structure:
    runs-on: ubuntu-latest
    outputs:
      needs_fix: ${{ steps.validate.outputs.needs_fix }}
      violations: ${{ steps.validate.outputs.violations }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ¦€ Setup Rust
        uses: dtolnay/rust-action@stable

      - name: ðŸ“¦ Cache validator
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            .github/actions/structure-validator/target/
          key: ${{ runner.os }}-cargo-validator-${{ hashFiles('.github/actions/structure-validator/Cargo.lock') }}

      - name: ðŸ”¨ Build validator
        run: |
          cd .github/actions/structure-validator
          cargo build --release
          cp target/release/structure-validator ../../../validator

      - name: ðŸ” Validate structure
        id: validate
        run: |
          OUTPUT=$(./validator --json 2>&1) || true
          echo "raw_output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if echo "$OUTPUT" | grep -q '"needs_fix": true'; then
            echo "needs_fix=true" >> $GITHUB_OUTPUT
            VIOLATIONS=$(echo "$OUTPUT" | jq -c '.violations // []')
            echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
          else
            echo "needs_fix=false" >> $GITHUB_OUTPUT
            echo "violations=[]" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“‹ Report results
        if: always()
        run: |
          echo "## ðŸ” Structure Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.validate.outputs.needs_fix }}" = "true" ]; then
            echo "âš ï¸ **Issues found that can be auto-fixed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo '${{ steps.validate.outputs.violations }}' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Structure is valid**" >> $GITHUB_STEP_SUMMARY
          fi

  create-fix-pr:
    needs: validate-structure
    if: needs.validate-structure.outputs.needs_fix == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ¤– Assign to Copilot for fix
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const violations = JSON.parse('${{ needs.validate-structure.outputs.violations }}');

            // Create issue for Copilot to fix
            const issueBody = `
            ## ðŸ”§ Auto-Fix Required: Structure Violations

            The structure validator found the following issues that need to be fixed:

            \`\`\`json
            ${JSON.stringify(violations, null, 2)}
            \`\`\`

            ### Requested Actions

            Please fix these structure violations:

            ${violations.map(v => `- [ ] ${v.type}: ${v.message} (${v.file || 'root'})`).join('\n')}

            ### Context

            - **Branch:** ${context.ref}
            - **Commit:** ${context.sha}
            - **Triggered by:** ${context.actor}

            ---

            *This issue was auto-generated by the Structure Validator workflow.*

            /assign @copilot
            `;

            // Check if similar issue already exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-fix,structure'
            });

            const hasExisting = existingIssues.data.some(
              issue => issue.title.includes('Structure Violations')
            );

            if (!hasExisting) {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”§ Auto-Fix: Structure Violations Detected',
                body: issueBody,
                labels: ['auto-fix', 'structure', 'copilot']
              });

              console.log(`Created issue #${issue.data.number}`);

              // Try to assign to Copilot (if available)
              try {
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.data.number,
                  assignees: ['copilot']
                });
              } catch (e) {
                console.log('Could not assign to Copilot:', e.message);
              }
            } else {
              console.log('Similar issue already exists, skipping creation');
            }
